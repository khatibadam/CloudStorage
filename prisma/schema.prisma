generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id_user String @id @default(cuid())
  firstname String
  lastname String
  email String @unique()
  password String
  otpCodes OtpCode[]
  subscription Subscription?
  projects Project[]
  invoices Invoice[]
  stripeCustomerId String? @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model Subscription {
  id String @id @default(cuid())
  userId String @unique
  user User @relation(fields: [userId], references: [id_user], onDelete: Cascade)

  stripeSubscriptionId String? @unique
  stripeCustomerId String
  stripePriceId String
  stripeCurrentPeriodEnd DateTime?

  planType PlanType @default(FREE)
  status SubscriptionStatus @default(INACTIVE)
  storageLimit BigInt // en octets
  storageUsed BigInt @default(0)

  cancelAtPeriodEnd Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
}

// Modèle Project - Feature principale du dashboard
model Project {
  id String @id @default(cuid())
  userId String
  user User @relation(fields: [userId], references: [id_user], onDelete: Cascade)

  name String
  description String?
  status ProjectStatus @default(ACTIVE)

  // Simulation de stockage pour le projet
  storageUsed BigInt @default(0)
  filesCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

enum ProjectStatus {
  ACTIVE
  ARCHIVED
  DELETED
}

// Modèle Invoice - Gestion des factures Stripe
model Invoice {
  id String @id @default(cuid())
  userId String
  user User @relation(fields: [userId], references: [id_user], onDelete: Cascade)

  stripeInvoiceId String @unique
  stripeCustomerId String
  stripeSubscriptionId String?

  amountDue Int // en centimes
  amountPaid Int // en centimes
  currency String @default("eur")

  status InvoiceStatus @default(DRAFT)
  invoiceUrl String? // URL de la facture PDF
  hostedInvoiceUrl String? // URL de la page Stripe

  periodStart DateTime?
  periodEnd DateTime?
  dueDate DateTime?
  paidAt DateTime?
  voidedAt DateTime?

  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([stripeInvoiceId])
  @@index([stripeCustomerId])
  @@index([status])
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
}

enum PlanType {
  FREE
  STANDARD
  PRO
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  PAST_DUE
  CANCELED
  TRIALING
}

model OtpCode {
  id String @id @default(cuid())
  userId String?
  user User? @relation(fields: [userId], references: [id_user], onDelete: Cascade)
  email String
  code String
  expiresAt DateTime
  verified Boolean @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([email])
  @@index([code])
}